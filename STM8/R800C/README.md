# مستندات جامع کار با مودم GSM
## راه‌اندازی، ارسال پیامک، برقراری تماس و دریافت پیامک

## فهرست مطالب
- [مقدمه](#مقدمه)
- [۱. راه‌اندازی اولیه مودم](#۱-راهاندازی-اولیه-مودم)
- [۲. ارسال پیامک (فارسی و انگلیسی)](#۲-ارسال-پیامک-فارسی-و-انگلیسی)
- [۳. برقراری تماس صوتی](#۳-برقراری-تماس-صوتی)
- [۴. دریافت و خواندن پیامک](#۴-دریافت-و-خواندن-پیامک)
- [۵. مدیریت حافظه پیامک](#۵-مدیریت-حافظه-پیامک)
- [۶. رویدادهای خودکار مودم (Indications)](#۶-رویدادهای-خودکار-مودم-indications)
- [۷. عیب‌یابی و خطاهای رایج](#۷-عیبیابی-و-خطاهای-رایج)
- [ضمیمه: نمونه لاگ‌های کامل](#ضمیمه-نمونه-لاگهای-کامل)

---

## مقدمه

این مستندات راهنمای کامل کار با مودم‌های GSM/GPRS (مانند SIM800، SIM900، R800C و...) از طریق دستورات AT است. سناریوهای زیر پوشش داده شده‌اند:

- راه‌اندازی و پیکربندی اولیه مودم
- ارسال پیامک به زبان فارسی (Unicode/UCS2)
- برقراری تماس صوتی و بررسی وضعیت تماس
- دریافت خودکار و خواندن پیامک‌های جدید
- مدیریت حافظه و پاکسازی پیامک‌ها

---

## ۱. راه‌اندازی اولیه مودم

### ۱.۱ همگام‌سازی با مودم (AT Sync)
```at
AT
```
**پاسخ موفق:** `OK`

این دستور برای بررسی ارتباط با مودم استفاده می‌شود. اگر مودم پاسخ ندهد، عملیات راه‌اندازی شکست می‌خورد.

### ۱.۲ تنظیم فرمت پاسخگویی
```at
ATV1
```
**پاسخ:** `OK`

تنظیم فرمت پاسخگویی مودم به حالت متنی (Verbose) به جای حالت عددی.

### ۱.۳ فعال‌سازی اکو
```at
ATE1
```
**پاسخ:** `OK`

فعال‌سازی تکرار دستورات در خروجی برای سهولت در دیباگ و عیب‌یابی.

### ۱.۴ فعال‌سازی گزارش خطای پیشرفته
```at
AT+CMEE=2
```
**پاسخ:** `OK`

فعال‌سازی نمایش خطاها به صورت متنی و قابل فهم.

### ۱.۵ بررسی و تنظیم نرخ باود (Baudrate)
```at
AT+IPR?
```
**پاسخ نمونه:** `+IPR: 115200`

بررسی سرعت ارتباط سریال بین مودم و میکروکنترلر/کامپیوتر.

### ۱.۶ دریافت اطلاعات مودم
```at
ATI
```
**پاسخ نمونه:**
```
R800C R1850
OK
```

دریافت اطلاعاتی شامل:
- مدل مودم (R800C)
- نسخه فریمور (R1850)

### ۱.۷ دریافت شماره IMEI
```at
AT+GSN
```
**پاسخ نمونه:** `863070040316472`

دریافت شماره سریال یکتای سخت‌افزار (IMEI).

### ۱.۸ بررسی وضعیت سیم‌کارت
```at
AT+CPIN?
```
**پاسخ نمونه:** `+CPIN: READY`

بررسی موارد زیر:
- وجود سیم‌کارت در اسلات
- نیاز یا عدم نیاز به رمز PIN
- آماده بودن سیم‌کارت برای عملیات شبکه

### ۱.۹ بررسی دستورات پشتیبانی شده (نمونه خطا)
```at
at+qaudch=?
```
**پاسخ:** `+CME ERROR: invalid command line`
> این دستور در این مودم پشتیبانی نمی‌شود و خطای "دستور نامعتبر" برگردانده شده است

---

## ۲. ارسال پیامک (فارسی و انگلیسی)

### ۲.۱ فعال‌سازی حالت متنی پیامک
```at
AT+CMGF=1
```
**پاسخ:** `OK`

تنظیم مودم برای کار با پیامک‌های متنی ساده (Text Mode).

### ۲.۲ تنظیم پارامترهای پیامک
```at
AT+CSMP=17,167,0,8
```
**پاسخ:** `OK`

تنظیم مشخصات پیامک:
- **17:** مدت اعتبار پیام (Validity Period)
- **167:** تنظیمات گزارش تحویل و نوع پیام
- **0:** بایت اضافی (معمولاً صفر)
- **8:** فعال‌سازی حالت UCS2 برای پشتیبانی از زبان فارسی

### ۲.۳ تنظیم نوع کاراکتر
```at
AT+CSCS="UCS2"
```
**پاسخ:** `OK`

تنظیم مودم برای دریافت کاراکترهای Unicode 16-bit (پشتیبانی از فارسی، عربی، چینی و...).

### ۲.۴ ارسال پیامک
```at
AT+CMGS="002B003900380039003900310038003500350035003300380034"
```
**پاسخ مودم:** `>`

شماره گیرنده به صورت UCS2 هگزادسیمال:
- `002B` = +
- `0039` = 9
- ...
- معادل: **+989918555384**

### ۲.۵ وارد کردن متن پیام
```
0633064406270645
```
**پاسخ موفق:** 
```
+CMGS: 34
OK
```

متن پیام به صورت UCS2:
- `0633` = س
- `0644` = ل
- `0627` = ا
- `0645` = م
- **معادل: "سلام"**

علامت `` (CTRL+Z) نشان‌دهنده پایان پیام است.

---

## ۳. برقراری تماس صوتی

### ۳.۱ شماره‌گیری
```at
ATD+989918555384;
```
> توجه: `;` در انتهای شماره برای تماس صوتی الزامی است

**پاسخ:** `OK`
> مودم دستور را پذیرفته و عملیات شماره‌گیری آغاز می‌شود

### ۳.۲ بررسی وضعیت تماس
```at
AT+CLCC
```
**پاسخ در حالت برقراری تماس:**
```
+CLCC: 1,0,2,0,0,"989918555384",145
OK
```
**پاسخ در حالت زنگ خوردن:**
```
+CLCC: 1,0,3,0,0,"989918555384",145
OK
```
**پاسخ پس از پایان تماس:**
```
OK
```

**توضیح پارامترهای +CLCC:**
| پارامتر | معنی | مقادیر ممکن |
|---------|------|-------------|
| 1 | ایندکس تماس | 1-7 |
| 0 | وضعیت (جهت) | 0=موبایل به شبکه، 1=ورودی |
| **2** یا **3** | **وضعیت تماس** | **0=فعال، 1=نگهداری، 2=برقراری، 3=زنگ خوردن، 4=انتظار** |
| 0 | نوع آدرس | 128=مشخص، 145=بین‌المللی |
| 0 | شماره‌گیری مجدد | |
| "989918555384" | شماره تلفن | |
| 145 | نوع شماره | 145=بین‌المللی |

### ۳.۳ قطع تماس
```at
ATH
```
**پاسخ:** `OK`
> قطع کردن تماس فعال (Hang up)

---

## ۴. دریافت و خواندن پیامک

### ۴.۱ اعلان خودکار پیامک جدید
```
+CMTI: "SM",1
```
> مودم به صورت خودکار اعلام می‌کند که پیامک جدیدی در حافظه SIM (حافظه "SM") با ایندکس ۱ ذخیره شده است

### ۴.۲ تنظیمات قبل از خواندن پیامک

**فعال‌سازی حالت متنی:**
```at
AT+CMGF=1
```
**پاسخ:** `OK`

**نمایش هدرهای پیامک:**
```at
AT+CSDH=1
```
**پاسخ:** `OK`
> با فعال بودن این گزینه، اطلاعات اضافی مانند زمان، وضعیت و... نمایش داده می‌شود

**تنظیم نوع کاراکتر (برای خواندن صحیح):**
```at
AT+CSCS="GSM"
```
**پاسخ:** `OK`
> اگر پیامک دریافتی فارسی باشد، باید از UCS2 استفاده کرد. برای پیامک انگلیسی GSM کافی است

### ۴.۳ خواندن پیامک با ایندکس مشخص
```at
AT+CMGR=1
```
**پاسخ (نمونه برای پیامک فارسی):**
```
+CMGR: "REC UNREAD","+989918555384",,"2026/02/22,06:20:21+14",145,17,0,8,"+9891100500",145,8
0633064406270645
OK
```

**تفسیر پاسخ:**
- **"REC UNREAD"**: وضعیت پیامک (خوانده نشده)
- **"+989918555384"**: شماره فرستنده
- **"2026/02/22,06:20:21+14"**: تاریخ و زمان دریافت
- **145**: نوع شماره فرستنده
- **8**: پارامتر نشان‌دهنده UCS2 (اگر 0 باشد یعنی GSM)
- **"0633064406270645"**: متن پیامک به صورت هگز (معادل "سلام")

### ۴.۴ غیرفعال‌سازی نمایش هدرها
```at
AT+CSDH=0
```
**پاسخ:** `OK`

---

## ۵. مدیریت حافظه پیامک

### ۵.۱ تغییر به حالت PDU
```at
AT+CMGF=0
```
**پاسخ:** `OK`
> حالت PDU برای مدیریت پیشرفته‌تر پیامک‌ها استفاده می‌شود

### ۵.۲ حذف پیامک‌ها
```at
AT+CMGD=1,4
```
**پاسخ:** `OK`

**توضیح دستور CMGD:**
- **1**: ایندکس شروع برای حذف
- **4**: نوع حذف
  - `0`: حذف پیامک با ایندکس مشخص
  - `1`: حذف تمام پیامک‌های خوانده شده
  - `2`: حذف تمام پیامک‌های خوانده شده و ارسال شده
  - `3`: حذف تمام پیامک‌های خوانده شده، ارسال شده و نگه داشته شده
  - **`4`**: **حذف تمام پیامک‌ها**

---

## ۶. رویدادهای خودکار مودم (Indications)

مودم به صورت خودکار رویدادهای زیر را گزارش می‌دهد:

### ۶.۱ رویدادهای تماس
```
+CIEV: "CALL",1   // تماس فعال شد
+CIEV: "SOUNDER",1 // زنگ تماس فعال شد (برای تماس ورودی)
+CIEV: "SOUNDER",0 // زنگ تماس قطع شد
+CIEV: "CALL",0    // تماس پایان یافت
BUSY               // خط مشغول است
```

### ۶.۲ رویدادهای پیامک
```
+CMTI: "SM",1      // پیامک جدید در حافظه SIM با ایندکس 1
```

---

## ۷. عیب‌یابی و خطاهای رایج

### خطاهای رایج در تماس
| خطا | علت | راه‌حل |
|-----|------|--------|
| `BUSY` | خط مشغول است | بعداً شماره‌گیری مجدد |
| `NO CARRIER` | تماس قطع شده | - |
| `NO ANSWER` | کسی پاسخ نداد | - |

### خطاهای رایج در پیامک
| خطا | علت | راه‌حل |
|-----|------|--------|
| `+CMS ERROR: 301` | حافظه SIM پر است | پیامک‌ها را پاک کنید |
| پیامک فارسی به صورت ??? نمایش داده می‌شود | نوع کاراکتر اشتباه است | از `AT+CSCS="UCS2"` استفاده کنید |

---

## ضمیمه: نمونه لاگ‌های کامل

### نمونه لاگ راه‌اندازی اولیه
```log
[2026-02-22 06:02:36:154_S:] AT
[2026-02-22 06:02:36:161_R:] OK

[2026-02-22 06:02:36:170_S:] ATV1
[2026-02-22 06:02:36:177_R:] OK

[2026-02-22 06:02:36:186_S:] ATE1
[2026-02-22 06:02:36:194_R:] OK

[2026-02-22 06:02:36:201_S:] AT+CMEE=2
[2026-02-22 06:02:36:210_R:] OK

[2026-02-22 06:02:36:217_S:] AT+IPR?
[2026-02-22 06:02:36:226_R:] +IPR: 115200

[2026-02-22 06:02:36:237_S:] ATI
[2026-02-22 06:02:36:247_R:] R800C R1850

[2026-02-22 06:02:36:269_S:] AT+GSN
[2026-02-22 06:02:36:278_R:] 863070040316472

[2026-02-22 06:02:36:349_S:] AT+CPIN?
[2026-02-22 06:02:36:373_R:] +CPIN: READY
```

### نمونه لاگ ارسال پیامک فارسی
```log
[2026-02-22 05:55:31:925_S:] AT+CMGF=1
[2026-02-22 05:55:31:934_R:] OK

[2026-02-22 05:55:31:935_S:] AT+CSMP=17,167,0,8
[2026-02-22 05:55:31:948_R:] OK

[2026-02-22 05:55:31:949_S:] AT+CSCS="UCS2"
[2026-02-22 05:55:31:958_R:] OK

[2026-02-22 05:55:31:961_S:] AT+CMGS="002B003900380039003900310038003500350035003300380034"
[2026-02-22 05:55:31:976_R:] > 0633064406270645
[2026-02-22 05:55:34:493_R:] +CMGS: 34
[2026-02-22 05:55:34:493_R:] OK
```

### نمونه لاگ تماس صوتی
```log
/* شماره‌گیری */
[2026-02-22 06:17:58:304_S:] ATD+989918555384;
[2026-02-22 06:17:58:320_R:] OK

/* تماس فعال شد */
[2026-02-22 06:18:00:064_R:] +CIEV: "CALL",1

/* بررسی وضعیت - تماس در حال برقراری */
[2026-02-22 06:18:01:355_S:] AT+CLCC
[2026-02-22 06:18:01:367_R:] +CLCC: 1,0,2,0,0,"989918555384",145

/* زنگ خوردن */
[2026-02-22 06:18:03:165_R:] +CIEV: "SOUNDER",1
[2026-02-22 06:18:04:356_S:] AT+CLCC
[2026-02-22 06:18:04:374_R:] +CLCC: 1,0,3,0,0,"989918555384",145

/* قطع تماس */
[2026-02-22 06:18:06:404_S:] ATH
[2026-02-22 06:18:06:663_R:] +CIEV: "CALL",0
[2026-02-22 06:18:06:663_R:] OK
```

### نمونه لاگ دریافت پیامک
```log
/* اعلان پیامک جدید */
[2026-02-22 06:19:06:299_R:] +CMTI: "SM",1

/* تنظیمات اولیه */
[2026-02-22 06:19:09:368_S:] AT+CMGF=1
[2026-02-22 06:19:09:377_R:] OK

[2026-02-22 06:19:09:386_S:] AT+CSCS="GSM"
[2026-02-22 06:19:09:395_R:] OK

/* خواندن پیامک */
[2026-02-22 06:19:09:396_S:] AT+CMGR=1
[2026-02-22 06:19:09:516_R:] +CMGR: "REC UNREAD","+989918555384",,"2026/02/22,06:20:21+14",145,17,0,8,"+9891100500",145,8
[2026-02-22 06:19:09:527_R:] 0633064406270645
[2026-02-22 06:19:09:527_R:] OK

/* پاکسازی حافظه */
[2026-02-22 06:19:13:898_S:] AT+CMGD=1,4
[2026-02-22 06:19:16:449_R:] OK
```

---

## نکات پایانی و بهترین روش‌ها

1. **مدیریت حافظه:** همیشه پس از خواندن پیامک‌ها، حافظه SIM را پاکسازی کنید تا فضای کافی برای پیامک‌های جدید وجود داشته باشد
2. **پشتیبانی از فارسی:** برای ارسال و دریافت فارسی، حتماً از `AT+CSCS="UCS2"` استفاده کنید
3. **مدیریت تماس:** با استفاده از `AT+CLCC` می‌توانید وضعیت دقیق تماس را مانیتور کنید
4. **رویدادها:** به رویدادهای خودکار مودم (`+CIEV` و `+CMTI`) توجه کنید تا برنامه شما واکنش به‌موقع نشان دهد
5. **تثبیت نرخ باود:** اگر باود روی حالت خودکار (0) است، حتماً آن را روی مقدار ثابت (مثلاً 115200) تنظیم و با `AT&W` ذخیره کنید

**با رعایت این نکات می‌توانید یک سیستم ارتباطی پایدار و حرفه‌ای با مودم GSM پیاده‌سازی کنید.**